<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>抽陀螺小游戏 - 鞭子版</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            /* 修改：不再使用 space-between，改为 column-reverse 和 padding */
            justify-content: flex-end; /* 将内容推到顶部，按钮在底部 */
            align-items: center;
            background-color: #87CEEB; /* 天空蓝背景 */
            font-family: Arial, sans-serif;
            overflow: hidden; /* 防止出现滚动条 */
            box-sizing: border-box; /* 确保 padding 不影响 height: 100vh */
        }

        /* 游戏标题 */
        .header {
            width: 100%;
            text-align: center;
            color: #fff;
            font-size: 24px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
            margin-top: 3px;/**********************************************************/
            z-index: 2; /* 确保标题在内容上方 */
        }

        /* 中间游戏区域 - 小人和陀螺 */
        .game-area {
            /* 计算可用高度 */
            height: calc(100vh - 100px - 100px - 20px); /* 视口高度 - 按钮区域高度(约) - 标题区域高度(约) - 一些余量 */
            min-height: 200px; /* 设置一个最小高度，防止空间过小 */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative; /* 为连击显示定位 */
            width: 100%; /* 确保占满宽度 */
            padding: 10px 0; /* 添加一点内边距 */
            box-sizing: border-box;
            /* 使用 transform 向上移动约陀螺半径 (90px) + 90px = 180px */
            transform: translateY(-180px);
        }

        /* 小人容器 - 使用 flex 布局，高度自适应 */
        .character-container {
            display: flex; /* 使用flex来排列内部元素 */
            flex-direction: column; /* 竖直排列 */
            align-items: center; /* 居中对齐 */
            width: 200px; /* 固定宽度 */
            margin-bottom: 20px; /* 与陀螺之间的间距 */
            position: relative; /* 为连击显示定位 */
        }

        /* 简化后的小人 - 只有头 */
        .character {
            position: relative; /* 相对定位，基于父容器排列 */
            width: 100%; /* 占满父容器 */
            height: 160px; /* 给一个固定高度，容纳头和鞭子 */
            display: flex;
            justify-content: center; /* 为鞭子定位 */
        }

        /* 新的圆形头像 */
        .head {
            position: absolute; /* 绝对定位，相对于 .character */
            top: 0; /* 紧贴容器顶部 */
            left: 50%;
            transform: translateX(-50%); /* 水平居中 */
            width: 100px; /* 头部直径 */
            height: 100px; /* 头部直径 */
            background-image: url('./images/character.png'); /* 引用图片 */
            background-size: cover; /* 覆盖整个元素，保持比例 */
            background-position: center; /* 居中 */
            background-repeat: no-repeat; /* 不重复 */
            border-radius: 50%;
            z-index: 3; /* 确保在鞭子的上方 */
            overflow: hidden; /* 确保图片超出部分被裁剪 */
        }

        /* 鞭子 - 一条细长的线条 */
        .whip {
            position: absolute; /* 绝对定位，相对于 .character */
            top: 100px; /* 从头的底部开始 (头高100px) */
            left: 50%;
            transform: translateX(-50%) rotate(0deg); /* 初始旋转角度 */
            width: 4px; /* 鞭子宽度 */
            height: 80px; /* 鞭子长度 */
            background-color: #8B4513; /* 鞭子颜色 (棕色) */
            border-radius: 2px; /* 鞭子头部圆角 */
            z-index: 2; /* 在陀螺下方，在人头下方 */
            transform-origin: top center; /* 旋转中心点在鞭子顶部 */
        }

        /* 鞭子的动画 - 抽打陀螺 */
        .whip.hit-animation {
            animation: whipCrack 0.2s ease-out forwards;
        }

        @keyframes whipCrack {
            0%   { transform: translateX(-50%) rotate(0deg); }
            30%  { transform: translateX(-50%) rotate(-120deg); } /* 快速甩出 */
            60%  { transform: translateX(-50%) rotate(45deg); }   /* 回抽 */
            100% { transform: translateX(-50%) rotate(0deg); }    /* 回到原位 */
        }

        /* 陀螺 - 使用Canvas容器 */
        .spinning-top-container {
            width: 180px; /* 陀螺直径 */
            height: 180px; /* 陀螺直径 */
            position: relative; /* 相对定位，基于父容器排列 */
            overflow: hidden;
            border-radius: 50%; /* 确保容器是圆形 */
        }

        .spinning-top-canvas {
            width: 100%;
            height: 100%;
        }

        /* 连击显示 - 位置在人头上方 */
        .combo-display {
            position: absolute;
            top: -60px; /* 在人头容器上方 */
            left: 50%;
            transform: translateX(-50%) scale(0);
            font-size: 40px; /* 字体大小 */
            font-weight: bold;
            color: #FFD700; /* 金色 */
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
            z-index: 100;
            pointer-events: none; /* 不影响点击 */
            white-space: nowrap; /* 防止文字换行 */
        }

        .combo-display.show {
            animation: comboPop 1s ease-out forwards;
        }

        @keyframes comboPop {
            0% { transform: translateX(-50%) scale(0); opacity: 0; }
            30% { transform: translateX(-50%) scale(1.2); opacity: 1; }
            100% { transform: translateX(-50%) scale(1); opacity: 0; }
        }

        /* 底部进度条和按钮区域 */
        .control-area {
            width: 100%;
            padding: 15px;
            box-sizing: border-box;
            background-color: #2C3E50; /* 深色背景 */
            position: fixed; /* 固定到底部 */
            left: 0;
            bottom: 0;
            z-index: 999; /* 确保在最上层 */
            padding-bottom: env(safe-area-inset-bottom); /* 动态调整底部安全区域 */
            /* 为不支持 env() 的浏览器提供一个默认值 */
            padding-bottom: 20px; /* 可根据需要调整 */
        }

        /* 针对不支持env()函数的老版本浏览器，可以使用固定的底部填充 */
        @supports not (padding-bottom: env(safe-area-inset-bottom)) {
            .control-area {
                padding-bottom: 20px; /* 根据实际需要调整 */
            }
        }

        /* 进度条容器 */
        .progress-container {
            width: 100%;
            height: 40px;
            background-color: #34495E;
            border-radius: 20px;
            position: relative;
            overflow: hidden;
            margin-bottom: 15px;
            border: 2px solid #7F8C8D;
        }

        /* 唯一的目标区域 */
        .target-zone {
            position: absolute;
            top: 0;
            left: 40%; /* 初始位置 */
            width: 40px; /* 宽度 */
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(46, 204, 113, 0.5), transparent);
            box-shadow: 0 0 10px rgba(46, 204, 113, 0.7);
            border-radius: 10px;
            z-index: 10;
        }

        /* 滚动的小球 */
        .ball {
            position: absolute;
            top: 5px;
            left: -30px; /* 初始在屏幕外 */
            width: 30px;
            height: 30px;
            background-color: #3498DB; /* 默认蓝色 (左箭头) */
            border-radius: 50%;
            z-index: 5; /* 恢复到之前的层级 */
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 16px;
            color: white;
            font-weight: bold;
        }

        .ball.right {
            background-color: #E74C3C; /* 右箭头球用红色 */
        }

        /* 操作按钮 - 左右两个 */
        .button-container {
            display: flex;
            justify-content: space-between;
            width: 100%;
            gap: 10px; /* 按钮间距 */
        }

        .action-button {
            flex: 1; /* 平分宽度 */
            height: 60px;
            font-size: 24px;
            font-weight: bold;
            color: white;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            box-shadow: 0 6px 0 #A5281B;
            transition: all 0.1s;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .action-button.left {
            background: linear-gradient(to bottom, #3498DB, #2980B9); /* 左按钮蓝色 */
        }

        .action-button.right {
            background: linear-gradient(to bottom, #E74C3C, #C0392B); /* 右按钮红色 */
        }

        .action-button:active {
            box-shadow: 0 2px 0 #A5281B;
            transform: translateY(4px);
        }

        /* 分数显示 */
        .score-display {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 20px;
            color: white;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 5px 10px;
            border-radius: 10px;
        }
    </style>
</head>
<body>

    <div class="header">
        <h1> JQI wcnm </h1>
    </div>

    <div class="game-area">
        <div class="character-container">
            <div class="character">
                <div class="head" id="characterHead"></div> <!-- ID用于JS引用 -->
                <div class="whip" id="whip"></div> <!-- 鞭子元素 -->
            </div>
            <div class="combo-display" id="comboDisplay">COMBO x1</div>
        </div>
        
        <!-- 陀螺现在使用Canvas -->
        <div class="spinning-top-container">
            <canvas class="spinning-top-canvas" id="spinningTopCanvas"></canvas>
        </div>
    </div>

    <div class="control-area">
        <div class="progress-container" id="progressBar">
            <div class="target-zone" id="targetZone"></div>
            <!-- 小球将通过JS动态添加 -->
        </div>
        <div class="button-container">
            <button class="action-button left" id="leftButton">←</button>
            <button class="action-button right" id="rightButton">→</button>
        </div>
        <div class="score-display">得分: <span id="score">0</span></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // 游戏元素获取
            const progressBar = document.getElementById('progressBar');
            const targetZone = document.getElementById('targetZone'); // 唯一的目标区
            const leftButton = document.getElementById('leftButton');
            const rightButton = document.getElementById('rightButton');
            const spinningTopCanvas = document.getElementById('spinningTopCanvas');
            const whip = document.getElementById('whip'); // 获取鞭子元素
            const scoreElement = document.getElementById('score');
            const comboDisplay = document.getElementById('comboDisplay');
            const characterHead = document.getElementById('characterHead');

            // 获取Canvas上下文
            const ctx = spinningTopCanvas.getContext('2d');

            // 设置Canvas尺寸 (新的陀螺尺寸)
            const canvasSize = 180; // 陀螺直径 180px
            spinningTopCanvas.width = canvasSize;
            spinningTopCanvas.height = canvasSize;

            // 游戏状态变量
            let score = 0;
            let combo = 0;
            let lastHitTime = 0;
            const COMBO_WINDOW = 1500; // 1.5秒内算作连击
            let isSpinning = false;
            let spinSpeed = 0;
            let gameActive = true;
            let ballIdCounter = 0;
            let rotationAngle = 0; // 陀螺旋转角度

            // 陀螺旋转相关
            const SPIN_INCREMENT = 200;
            const FRICTION = 0.98;
            const MIN_SPEED = 10;

            // 进度条参数
            const PROGRESS_WIDTH = progressBar.offsetWidth;
            const BALL_SIZE = 30;
            const TARGET_WIDTH = 40;
            const BALL_SPEED = 1.2;
            const BALL_SPAWN_INTERVAL = 500;
            const BALL_SPAWN_VARIANCE = 1000;

            // 记录最近一次按下的按钮方向
            let lastPressedDirection = null;

            // 预加载图片
            const topImage = new Image();
            topImage.src = './images/top.png'; // 图片路径

            // 当陀螺图片加载完成后，进行初始化
            topImage.onload = function() {
                // 图片加载成功后，绘制初始帧
                drawTop(rotationAngle);
            };

            topImage.onerror = function() {
                console.error("陀螺图片加载失败，请检查路径 './images/top.png'");
                // 可以选择绘制一个默认的圆形作为备选
                drawTop(rotationAngle);
            };

            // 绘制陀螺到Canvas的函数
            function drawTop(angle) {
                ctx.save(); // 保存当前状态
                ctx.clearRect(0, 0, canvasSize, canvasSize); // 清空画布

                // 移动到画布中心并旋转
                ctx.translate(canvasSize / 2, canvasSize / 2);
                ctx.rotate(angle);

                // 计算裁剪圆形的半径
                const radius = canvasSize / 2; // 180 / 2 = 90

                // 开始路径并创建圆形剪辑区域
                ctx.beginPath();
                ctx.arc(0, 0, radius, 0, Math.PI * 2);
                ctx.closePath();
                ctx.clip(); // 应用剪辑区域

                // 绘制图片，填充圆形区域
                // 假设图片是正方形，或者我们希望它填充圆形
                ctx.drawImage(topImage, -radius, -radius, canvasSize, canvasSize);

                ctx.restore(); // 恢复之前的状态
            }

            // 移动目标区域 (唯一的区域)
            function moveTarget() {
                if (!gameActive) return;
                const maxLeft = PROGRESS_WIDTH - TARGET_WIDTH;
                const newLeft = Math.max(0, Math.min(maxLeft, targetZone.offsetLeft + (Math.random() * 4 - 2)));
                targetZone.style.left = newLeft + 'px';
            }
            setInterval(moveTarget, 300);

            // 创建小球 (随机方向)
            function createBall() {
                if (!gameActive) return;
                const ball = document.createElement('div');
                ball.className = 'ball';
                
                // 随机决定方向 (0: 左, 1: 右)
                const isRight = Math.random() > 0.5;
                if (isRight) {
                    ball.classList.add('right');
                    ball.textContent = '→'; // 右箭头
                    ball.direction = 'right';
                } else {
                    ball.textContent = '←'; // 左箭头
                    ball.direction = 'left';
                }
                
                ball.id = 'ball-' + ballIdCounter++;
                ball.processed = false;
                progressBar.appendChild(ball);
            }

            // 移动小球
            function moveBalls() {
                if (!gameActive) return;
                const balls = document.querySelectorAll('.ball');
                balls.forEach(ball => {
                    const currentLeft = parseFloat(ball.style.left) || ball.offsetLeft;
                    const newLeft = currentLeft + BALL_SPEED;
                    ball.style.left = newLeft + 'px';

                    if (newLeft > PROGRESS_WIDTH) {
                        ball.remove();
                    }
                });
                requestAnimationFrame(moveBalls);
            }
            moveBalls();

            // 生成小球的定时器
            function startBallSpawner() {
                if (!gameActive) return;
                createBall();
                const nextSpawn = BALL_SPAWN_INTERVAL + Math.random() * BALL_SPAWN_VARIANCE;
                setTimeout(startBallSpawner, nextSpawn);
            }
            startBallSpawner();

            // 显示连击
            function showCombo() {
                comboDisplay.textContent = `COMBO x${combo}`;
                comboDisplay.classList.remove('show');
                void comboDisplay.offsetWidth;
                comboDisplay.classList.add('show');
            }

            // 重置连击
            function resetCombo() {
                combo = 0;
                lastHitTime = 0; // 重置连击时间
            }

            // 为左右按钮添加事件监听器
            // 按下按钮时，只记录方向，不立即处理碰撞
            leftButton.addEventListener('click', () => {
                lastPressedDirection = 'left';
            });

            rightButton.addEventListener('click', () => {
                lastPressedDirection = 'right';
            });

            // 碰撞检测主循环
            function checkCollisions() {
                if (!gameActive) return;

                const targetLeft = targetZone.offsetLeft;
                const targetRight = targetLeft + TARGET_WIDTH;

                // 获取当前按下的方向，并重置
                const currentDirection = lastPressedDirection;
                if (currentDirection) {
                     lastPressedDirection = null; // 仅在有按键时重置

                    const balls = document.querySelectorAll('.ball');
                    let hit = false;

                    balls.forEach(ball => {
                        if (ball.processed) return; // 跳过已处理的球

                        const ballLeft = parseFloat(ball.style.left) || ball.offsetLeft;
                        const ballRight = ballLeft + BALL_SIZE;

                        // 检查碰撞：球在区域内 且 方向匹配
                        if (ballLeft <= targetRight && ballRight >= targetLeft && ball.direction === currentDirection) {
                            ball.processed = true; // 标记为已处理
                            ball.remove(); // 移除球
                            hit = true;
                        }
                    });

                    if (hit) {
                        // --- 成功击中 ---
                        score++;
                        scoreElement.textContent = score;

                        const currentTime = Date.now();
                        // 检查是否在连击窗口内
                        if (combo > 0 && currentTime - lastHitTime < COMBO_WINDOW) {
                            // 如果当前已有连击且在窗口内，则增加
                            combo++;
                        } else {
                            // 否则，重置为1
                            combo = 1;
                        }
                        lastHitTime = currentTime; // 更新最后击中时间
                        showCombo();

                        // 触发鞭子的动画
                        whip.classList.add('hit-animation');
                        whip.addEventListener('animationend', () => {
                            whip.classList.remove('hit-animation');
                        }, { once: true }); // 确保动画结束后只移除一次类名

                        spinSpeed = Math.min(spinSpeed + SPIN_INCREMENT, 1000);
                        updateTopSpin(true);
                    } else {
                        // --- 按了键但没击中，或者击中了错误方向，重置连击 ---
                        resetCombo();
                    }
                }
                requestAnimationFrame(checkCollisions);
            }
            checkCollisions(); // 启动碰撞检测循环

            // 更新陀螺旋转状态
            function updateTopSpin(isHit) {
                if (isHit) {
                    if (!isSpinning) {
                        isSpinning = true;
                        requestAnimationFrame(animateTop); // 启动旋转动画
                    }
                }
            }

            // 陀螺旋转动画循环
            function animateTop() {
                if (isSpinning) {
                    rotationAngle += spinSpeed / 1000; // 根据速度更新角度
                    drawTop(rotationAngle); // 重新绘制
                    requestAnimationFrame(animateTop); // 继续循环
                }
            }

            // 陀螺减速逻辑
            function decelerateTop() {
                if (!gameActive) return;
                if (isSpinning) {
                    spinSpeed *= FRICTION;
                    if (spinSpeed > MIN_SPEED) {
                        // 速度改变时，动画循环会自动使用新的spinSpeed来计算角度
                    } else {
                        isSpinning = false;
                        spinSpeed = 0;
                    }
                }
                requestAnimationFrame(decelerateTop);
            }
            decelerateTop();

        });
    </script>

</body>
</html>
